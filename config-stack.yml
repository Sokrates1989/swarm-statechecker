version: "3.9"

services:

  api:
    image: ${IMAGE_NAME}:${IMAGE_VERSION}
    environment:
      # API Authentication.
      - SERVER_AUTHENTICATION_TOKEN_FILE=/run/secrets/STATECHECKER_SERVER_AUTHENTICATION_TOKEN
      - SERVER_AUTHENTICATION_TOKEN=${SERVER_AUTHENTICATION_TOKEN}
      # Logging.
      - TIMEZONE=${TIMEZONE}
      # Database connection.
      - DB_HOST=${STACK_NAME}_db
      - DB_USER=state_checker
      - DB_PW_FILE=/run/secrets/STATECHECKER_SERVER_DB_USER_PW
      - DB_NAME=state_checker
      # Config file with website, folders and tools to check.
      - STATECHECKER_SERVER_CONFIG=${STATECHECKER_SERVER_CONFIG}
    secrets:
      - STATECHECKER_SERVER_AUTHENTICATION_TOKEN
      - STATECHECKER_SERVER_DB_USER_PW
    networks:
      - state-checker-net
      - traefik
    volumes:
      - ${DATA_ROOT}/logs/api:/code/logs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${API_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      labels:
        # Traefik.
        - traefik.enable=true
        - traefik.constraint-label=traefik-public
        - traefik.http.services.statechecker-server-api.loadbalancer.server.port=${API_PORT}
        - traefik.http.routers.statechecker-server-api.rule=Host(`${API_URL}`)
        - traefik.http.routers.statechecker-server-api.entrypoints=https,http,web
        - traefik.http.routers.statechecker-server-api.tls=true
        - traefik.http.routers.statechecker-server-api.tls.certresolver=le
      mode: replicated
      replicas: ${API_REPLICAS:-1}
    command: ["uvicorn", "main_api_startpoint:app", "--host", "0.0.0.0", "--port", "${API_PORT}"]


  check:
    image: ${IMAGE_NAME}:${IMAGE_VERSION}
    environment:
      # Logging.
      - TIMEZONE=${TIMEZONE}
      # Check Frequency.
      - CHECK_WEBSITES_EVERY_X_MINUTES=${CHECK_WEBSITES_EVERY_X_MINUTES}
      - CHECK_GOOGLEDRIVE_EVERY_X_MINUTES=${CHECK_GOOGLEDRIVE_EVERY_X_MINUTES}
      # Database connection.
      - DB_HOST=${STACK_NAME}_db
      - DB_USER=state_checker
      - DB_PW_FILE=/run/secrets/STATECHECKER_SERVER_DB_USER_PW
      - DB_NAME=state_checker
      # Config file with website, folders and tools to check.
      - STATECHECKER_SERVER_CONFIG=${STATECHECKER_SERVER_CONFIG}
      # Google Drive Backup check.
      - GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON_FILE=/run/secrets/STATECHECKER_SERVER_GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON
      ## Messaging ##
      - STATUS_MESSAGES_TIME_OFFSET_PERCENTAGE=${STATUS_MESSAGES_TIME_OFFSET_PERCENTAGE}
      # Email.
      - EMAIL_ENABLED=${EMAIL_ENABLED}
      - EMAIL_SENDER_USER=${EMAIL_SENDER_USER}
      - EMAIL_SENDER_PASSWORD_FILE=/run/secrets/STATECHECKER_SERVER_EMAIL_SENDER_PASSWORD
      - EMAIL_SENDER_PASSWORD=${EMAIL_SENDER_PASSWORD}
      - EMAIL_SENDER_HOST=${EMAIL_SENDER_HOST}
      - EMAIL_SENDER_PORT=${EMAIL_SENDER_PORT}
      - EMAIL_RECIPIENTS_ERROR=${EMAIL_RECIPIENTS_ERROR}
      - EMAIL_RECIPIENTS_INFORMATION=${EMAIL_RECIPIENTS_INFORMATION}
      # Telegram.
      - TELEGRAM_ENABLED=${TELEGRAM_ENABLED}
      - TELEGRAM_STATUS_MESSAGES_EVERY_X_MINUTES=${TELEGRAM_STATUS_MESSAGES_EVERY_X_MINUTES}
      - TELEGRAM_SENDER_BOT_TOKEN_FILE=/run/secrets/STATECHECKER_SERVER_TELEGRAM_SENDER_BOT_TOKEN
      - TELEGRAM_SENDER_BOT_TOKEN=${TELEGRAM_SENDER_BOT_TOKEN}
      - TELEGRAM_RECIPIENTS_ERROR_CHAT_IDS=${TELEGRAM_RECIPIENTS_ERROR_CHAT_IDS}
      - TELEGRAM_RECIPIENTS_INFO_CHAT_IDS=${TELEGRAM_RECIPIENTS_INFO_CHAT_IDS}
    secrets:
      - STATECHECKER_SERVER_DB_USER_PW
      - STATECHECKER_SERVER_GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON
      - STATECHECKER_SERVER_TELEGRAM_SENDER_BOT_TOKEN
      - STATECHECKER_SERVER_EMAIL_SENDER_PASSWORD
    networks:
      - state-checker-net
    volumes:
      - ${DATA_ROOT}/logs/check:/code/logs
    deploy:
      mode: replicated
      replicas: ${CHECK_REPLICAS:-1}
    command: ["python", "src/check_tools.py"]


  db:
    image: mysql:8
    environment:
      - MYSQL_DATABASE=state_checker
      - MYSQL_USER=state_checker
      - MYSQL_PASSWORD_FILE=/run/secrets/STATECHECKER_SERVER_DB_USER_PW
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/STATECHECKER_SERVER_DB_ROOT_USER_PW
    secrets:
      - STATECHECKER_SERVER_DB_USER_PW
      - STATECHECKER_SERVER_DB_ROOT_USER_PW
    networks:
      - state-checker-net
    volumes:
      - ${DATA_ROOT}/db_data:/var/lib/mysql
      - ${DATA_ROOT}/install/database/state_checker.sql:/docker-entrypoint-initdb.d/init.sql
    deploy:
      mode: replicated
      replicas: 1

  db-migration:
    image: mysql:8.4
    environment:
      - MYSQL_DATABASE=state_checker
      - MYSQL_USER=state_checker
      - MYSQL_HOST=${STACK_NAME}_db
    secrets:
      - STATECHECKER_SERVER_DB_USER_PW
    networks:
      - state-checker-net
    volumes:
      - ${DATA_ROOT}/install/database/migrations:/scripts
    entrypoint: ["/bin/bash", "/scripts/run_migrations.sh"]
    deploy:
      restart_policy:
        condition: none

  phpmyadmin:
    image: phpmyadmin:5.2
    environment:
      - PMA_HOST=${STACK_NAME}_db
    networks:
      - state-checker-net
      - traefik
    deploy:
      labels:
        - traefik.enable=true
        - traefik.constraint-label=traefik-public
        - traefik.http.services.statechecker-server-phpmyadmin.loadbalancer.server.port=80
        - traefik.http.routers.statechecker-server-phpmyadmin.rule=Host(`${PHPMYADMIN_URL}`)
        - traefik.http.routers.statechecker-server-phpmyadmin.entrypoints=https,http,web
        - traefik.http.routers.statechecker-server-phpmyadmin.tls=true
        - traefik.http.routers.statechecker-server-phpmyadmin.tls.certresolver=le
      mode: replicated
      replicas: ${PHPMYADMIN_REPLICAS}


  web:
    image: ${WEB_IMAGE_NAME}:${WEB_IMAGE_VERSION}
    environment:
      - API_UPSTREAM=${STACK_NAME}_api:${API_PORT}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - state-checker-net
      - traefik
    deploy:
      labels:
        - traefik.enable=true
        - traefik.constraint-label=traefik-public
        - traefik.http.services.statechecker-server-web.loadbalancer.server.port=80
        - traefik.http.routers.statechecker-server-web.rule=Host(`${WEB_URL}`)
        - traefik.http.routers.statechecker-server-web.entrypoints=https,http,web
        - traefik.http.routers.statechecker-server-web.tls=true
        - traefik.http.routers.statechecker-server-web.tls.certresolver=le
      mode: replicated
      replicas: ${WEB_REPLICAS}

    
networks:
  state-checker-net:
    driver: overlay
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK_NAME:-traefik}

secrets:
  "STATECHECKER_SERVER_AUTHENTICATION_TOKEN":
    external: true
  "STATECHECKER_SERVER_DB_USER_PW":
    external: true
  "STATECHECKER_SERVER_DB_ROOT_USER_PW":
    external: true
  "STATECHECKER_SERVER_GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON":
    external: true
  "STATECHECKER_SERVER_TELEGRAM_SENDER_BOT_TOKEN":
    external: true
  "STATECHECKER_SERVER_EMAIL_SENDER_PASSWORD":
    external: true

