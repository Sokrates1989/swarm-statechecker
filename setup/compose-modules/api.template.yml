
  # Statechecker API Service
  api:
    image: ${IMAGE_NAME}:${IMAGE_VERSION}
    environment:
      # API Authentication.
      - SERVER_AUTHENTICATION_TOKEN_FILE=/run/secrets/STATECHECKER_SERVER_AUTHENTICATION_TOKEN
      - SERVER_AUTHENTICATION_TOKEN=${SERVER_AUTHENTICATION_TOKEN}
      # Logging.
      - TIMEZONE=${TIMEZONE}
      # Debug settings.
      - DEBUG_ENABLED=${DEBUG_ENABLED:-false}
      # Tools API tolerance period.
      - TOOLS_USING_API_TOLERANCE_PERIOD_IN_SECONDS=${TOOLS_USING_API_TOLERANCE_PERIOD_IN_SECONDS:-100}
      # Database connection.
      - DB_HOST=${STACK_NAME}_db
      - DB_USER=state_checker
      - DB_PW_FILE=/run/secrets/STATECHECKER_SERVER_DB_USER_PW
      - DB_NAME=state_checker
      # Initial data seeding (only used on first startup if database is empty).
      - INIT_WEBSITES=${INIT_WEBSITES:-}
      - INIT_GOOGLE_DRIVE_FOLDERS=${INIT_GOOGLE_DRIVE_FOLDERS:-}
      # Keycloak authentication (required for Web UI).
      - KEYCLOAK_ENABLED=true
      - KEYCLOAK_URL=${KEYCLOAK_URL:-}
      - KEYCLOAK_INTERNAL_URL=${KEYCLOAK_INTERNAL_URL:-}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-}
      - KEYCLOAK_CLIENT_SECRET_FILE=/run/secrets/STATECHECKER_SERVER_KEYCLOAK_CLIENT_SECRET
    secrets:
      - STATECHECKER_SERVER_AUTHENTICATION_TOKEN
      - STATECHECKER_SERVER_DB_USER_PW
      - STATECHECKER_SERVER_KEYCLOAK_CLIENT_SECRET
    networks:
      - backend
###PROXY_NETWORK###
    volumes:
      - ${DATA_ROOT}/logs/api:/code/logs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${API_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
###PROXY_LABELS###
###PROXY_PORTS###
      mode: replicated
      replicas: ${API_REPLICAS:-1}
    command: ["uvicorn", "main_api_startpoint:app", "--host", "0.0.0.0", "--port", "${API_PORT}"]

